<!doctype html>
<html lang="en">
        <head>
            <meta charset="utf-8">
            <title>CoreOs-SOLISC</title>
            <link rel="stylesheet" href="reveal.js-3.0.0/css/reveal.css">
            <link rel="stylesheet" href="reveal.js-3.0.0/css/theme/black.css" id="theme">
            <link rel="stylesheet" href="reveal.js-3.0.0/lib/css/zenburn.css">
        </head>
        <body>
            <div class="reveal">
                <!-- Any section element inside of this container is displayed as a slide -->
                <div class="slides">
<section data-transition="zoom" data-background="images/ppt_capakingrus.png">
        <div style="position:absolute;top:-150px;left:-100px;">
            <h2>Apresentação</h2>
            <h4>CoreOs, Docker e PXE</h4>
            <p>
                <small>Realizado por Helber Maciel Guerra para <a href="http://www.cianet.ind.br">Cianet</a> / <a href="http://twitter.com/helber">@helber</a></small>
            </p>
        </div>
</section>
<section data-markdown style="font-size:23px;">
Agenda
========
- De onde vem a necessidade (5 min.)
    - IPTV
    - Servidores e serviços
    - Como escala
    - Testes de carga
- Caminho seguido (10 min.)
    - Resolver isolamento
    - Passagem de parametros
    - Muitas instancias do browser
    - CoreOS
- Como funciona tudo? (25 min.)
    - DHCP
    - CoreOS inicia
    - Etcd
    - Fleet
    - Serviços
    - Exemplos de execução
- Agradescimentos
</section>
<section>
    <section>
        <h3>De onde veio a necessidade?</h3>
        <h4>Sistema de IPTV - com um navegador web como UI</h4>
        <h4>SetTopBox na casa do usuário</h4>
        <aside class="notes">
            Caracteristicas do sistema
        </aside>
    </section>
    <section>
        Este sistema é fornecido para provedores de internet (ISP)<br/>
        Utiliza a infraestrutura de rede do provedor para transmitir<br/>
        Necessário alta velocidade (Fibra ótica)
        Não é TV via internet
    </section>
    <section data-background-video="video/tv.mp4" type="video/mp4"></section>
    <section>TV gravações no servidor</section>
    <section data-background-video="video/tvod.mp4" type="video/mp4"></section>
    <section>
        TUDO é armazenado no servidor<br/>
        (volume, canal atual, audio e legenda de cada canal)
    </section>
    <section data-background-video="video/config.mp4" type="video/mp4"></section>
    <section>Conexão persistente (WebSockets) e conectividade total</section>
    <section data-background-video="video/remoto.mp4" type="video/mp4"></section>
    <section>Centenas de requisições do usuário por minuto</section>
    <section data-background="images/desenho_rede_1.png"></section>
    <section data-background="images/DiagramaIPTV.png"></section>
    <section>
        <p>Caracteristicas:</p>
        <ul>
            <li class="fragment"><i>Single page application</i></li>
            <li class="fragment">Grande interatividade</li>
            <li class="fragment">Muitas requisições para cada comando do usuário</li>
            <li class="fragment">Conexões "persistentes"</li>
            <li class="fragment">Frontend evoluindo muito rapidamente</li>
            <li class="fragment">Too Many Open Sockets</li>
            <li class="fragment">Too Many Open Files</li>
            <li class="fragment">Carga de arquivos estáticos</li>
            <li class="fragment">Carga e consumo de banco</li>
            <li class="fragment">Limites nas aplicações</li>
        </ul>
    </section>
    <section>
        <p>Tentativas:</p>
        <ul>
            <li class="fragment">Vários testes de carga com requests - <span style="color:red;">#FAIL</span></li>
            <li class="fragment">Baseados em <b>logs</b> - <span style="color:red;">#FAIL</span></li>
            <li class="fragment">Direto no javascript (Simulando digitação - controle remoto) - <span style="color:green;">#SUCCESS</span></li>
        </ul>
    </section>
</section>

<section>
    <section>
        <h3>Caminho seguido</h3>
        <h4>Abrir multiplas instâncias de browser com parametros</h4>
<pre class="shell"><code>
# Rodando chrome - teste
$ /opt/google/chrome/chrome_sandbox --kiosk \
--disk-cache-size=1 --media-cache-size=1 \
--disable-simple-cache --disable-cache \
--user-agent="serial=Helber;mac=FF:00:00:00:00:97;" \
"http://middleware.iptvdomain/debug/?profile_test=guide_programmes#repg"
</code></pre>
        <p class="fragment">Chrome compartilha processos recursos</p>
        <p class="fragment">Multiplas instancias <span style="color:red;">#FAIL</span></p>
        <p class="fragment">Multiplas abas <span style="color:red;">#FAIL</span></p>
        <aside class="notes">
            Chrome compartilha recursos
        </aside>
    </section>

    <section>
        <h3>Resolver isolamento</h3>
        <p>(Docker)</p>
<pre class="shell"><code>
# Rodando chrome - teste
/usr/bin/docker run -p 5900 --rm --privileged \
 -e IPTV_PROTO=http \
 -e IPTV_DISABLE_CACHE=false \
 -e IPTV_SERIAL=FAKE_00000000000000000010 \
 -e IPTV_MAC=00:00:00:00:00:0A \
 -e IPTV_HOST=middleware.iptvdomain \
 -e IPTV_PATH=debug/?profile_test=guide_programmes#repg \
 --name cianet-chrome-test-10 helber/google-chrome-test
</code></pre>
        <ul>
        <li class="fragment">Enjaulei o bicho <span class="fragment" style="color:green;">#SUCCESS</span></li>
        <li class="fragment">Consumo de recursos, pouca coisa a mais que o próprio processo<span style="color:green;">#SUCCESS</span></li>
        <li class="fragment">Meta de teste simular 7.000 usuários simultâneos</li>
        <li class="fragment">Agora só tenho que colocar mais 6999 <span class="fragment" style="color:red;">BUÁÁÁ</span></li>
        <aside class="notes">
            Chrome compartilha recursos
        </aside>
        </ul>
    </section>
</section>


<section data-markdown>
- Caminho seguido
    - Muitas instancias do browser (muitos containers docker)
        - Servidores?
        - Agentes que lançam os dockers?
    - CoreOS
        - 140 Mb comprimido
        - Não roda Python, Perl, Ruby, Javascript, ...
        - Sem gerenciamento de pacotes
        - Sem compilador
        - Orquestração de serviços
        - Se um servidor cair os serviços são iniciados automaticamente nos outros
        - Resolve conflitos entre instancias de containers
        - Ex.:
            - rode o X no mesmo servidor de Y
            - Não deixe o X rodar no mesmo servidor de Y
            - Somente uma instancia do Z pode estar rodando
            - Roda somente no servidor X
- Como funciona tudo?
    - DHCP:
        - Código
    - CoreOS inicia:
        - Carrega o arquivo de spec de inicialização (cloud-configs)
            - Código
        - libvirt
            - Código
    - Etcd
        - Banco de dados chave valor
        >etcdctl ls --recursive /_coreos.com
    - Fleet
        - Interface de cluster para o systemd
        - Consulta o etcd
            - Exemplo de código
    - Serviços
        - Exemplo de código
    - Exemplos de execução
- Agradescimentos
</section>
<section data-transition="concave">
    <section>
        <p>Principais componentes:</p>
        <ul>
            <li class="fragment">Docker (Containers e isolamento)</li>
            <li class="fragment">Etcd (Banco de dados - chave/valor)</li>
            <li class="fragment">Fleet (Agente / Orquestração)</li>
            <li class="fragment"></li>
        </ul>
    </section>
    <section data-transition="zoom">
TODO: REMOVE
<pre class="stretch"><code>
$ docker run -d -v ~/chef/cookbook:/cookbook --name chefdk spheromak/docker-chefdk sleep 6000000
$ docker exec -ti chefdk bundle install
$ docker exec -ti chefdk rake test</code></pre>
</code></pre>
</section>
<section>
    <h2><b>Logging</b> and Metrics</h2>
    <br><br>
    <p>But my app doesn't log to stdout/stderr.
        <div class="fragment">
            <p>It does now!
                <pre><code>
# /etc/nginx/nginx.conf
worker_processes 1;
daemon off;
user app app;
pid /app/nginx.pid;
error_log /dev/stderr;
access_log /dev/stdout;
...
</code></pre>
        </div>
    </section>
    <section data-background="#000">V2</section>
    <section data-background-transition="concave">V3 - Vídeo
        <video>
            <source src="file:///mnt/projetos/gerais/videos/iptv/20130613_091547.mp4" type="video/mp4" autoplay=true controls=true />
            </video>
        </section>
        <section data-background-video="file:///mnt/projetos/gerais/videos/iptv/20130613_091547.mp4">Este é um vídeo em background</section>
    </section>
</section>
        </div>
    </div>
    <script src="reveal.js-3.0.0/lib/js/head.min.js"></script>
    <script src="reveal.js-3.0.0/js/reveal.js"></script>
    <script>
    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        slideNumber: true,
        transition: 'slide', // none/fade/slide/convex/concave/zoom
        // Optional reveal.js plugins
        dependencies: [
            { src: 'reveal.js-3.0.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: 'reveal.js-3.0.0/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'reveal.js-3.0.0/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: 'reveal.js-3.0.0/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
            { src: 'reveal.js-3.0.0/plugin/zoom-js/zoom.js', async: true },
            { src: 'reveal.js-3.0.0/plugin/notes/notes.js', async: true }
        ]
    });
    </script>
</body>
</html>
